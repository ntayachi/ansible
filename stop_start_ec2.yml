hosts: localhost
connection: local
gather_facts: false

vars_files:
  - vault.yml

vars:
  - username:  "<aws-username>"
  - instanceId: "<ec2-instance-id>"
  - accountId: "<source-account-id>"
  - targetAccountId: "<target-account-id>"
  - targetRole: "<target-role>"
  - roleSession: "<role-session-name>"

tasks:

- name: Get MFA token
  shell: oathtool --totp --base32 <secret>
  register: mfa_token
  tags:
  - start
  - stop

- name: Switch to the target role
  sts_assume_role:
    aws_access_key: "{{ ec2_access_key }}"
    aws_secret_key: "{{ ec2_secret_key }}"
    mfa_serial_number: "arn:aws:iam::{{ accountId }}:mfa/{{ username }}"
    mfa_token: "{{ mfa_token['stdout'] }}"
    role_arn: "arn:aws:iam::{{ targetAccountId }}:role/{{ targetRole }}"
    role_session_name: "{{ roleSession }}"
  register: assumed_role
  tags:
  - start
  - stop
